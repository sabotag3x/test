<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>MusicDuel</title>

<style>
*{box-sizing:border-box}

body{
  margin:0;
  min-height:100vh;
  background:#000;
  color:#fff;
  font-family:Arial,sans-serif;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:1600px;
  padding:20px;
  text-align:center;
}

/* ===== HOME ===== */

#home{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:26px;
}

h1{font-size:44px;margin:0}

.subtitle{opacity:.85;font-size:18px}

.lists{
  display:flex;
  justify-content:center;
  margin-top:30px;
}

button{
  background:#ffbf2f;
  border:none;
  padding:16px 40px;
  border-radius:40px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
}

/* ===== GAME ===== */

#game{
  display:none;
  min-height:85vh;
  flex-direction:column;
  justify-content:center;
}

.duel{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:120px;
  min-height:520px;
}

.card{
  width:300px;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.card img{
  width:100%;
  border-radius:18px;
  cursor:pointer;
  transition:.2s;
}
.card img:hover{transform:scale(1.05)}

.title{
  margin-top:14px;
  font-size:20px;
  font-weight:bold;
}

/* ===== RESULTADO (BRACKET) ===== */

.bracket{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:5%;
  width:100%;
  max-width:1400px;
  margin:auto;
}

.side{
  display:flex;
  gap:18px;
  align-items:center;
}

.round{
  display:flex;
  flex-direction:column;
  gap:12px;
}

.round img{border-radius:8px}
.r1 img{width:56px}
.r2 img{width:80px}
.r3 img{width:110px}
.r4 img{width:140px}

.champion{
  display:flex;
  flex-direction:column;
  align-items:center;
  width:40%;
  max-width:420px;
}

.champion img{
  width:100%;
  max-width:360px;
  border-radius:16px;
}

.champion .title{
  font-size:24px;
  font-weight:bold;
  margin-top:10px;
}

#again{margin-top:20px}

/* ===== MOBILE ===== */

@media(max-width:900px){
  .bracket{flex-direction:column;gap:16px}
  .side{flex-direction:column}
}
</style>
</head>

<body>

<div class="container">

<!-- ===== HOME ===== -->
<div id="home">
  <h1>MusicDuel</h1>
  <div class="subtitle">Batalha entre bandas e artistas</div>

  <div class="lists">
    <button onclick="startList('test')">Bandas – Teste</button>
  </div>
</div>

<!-- ===== GAME ===== -->
<div id="game">
  <div id="duel"></div>
</div>

</div>

<script>
let pool=[], items=[], atual=[], idx=0, winners=[], rounds=[];
let initialRound=[];

function shuffle(a){return a.sort(()=>Math.random()-.5)}

async function startList(key){
  document.getElementById("home").style.display="none";
  document.getElementById("game").style.display="flex";

  try{
    const res = await fetch(`/api/music/list/${key}`);
    const data = await res.json();

    const seen = new Set();
    const clean = data.artists
      .filter(a => a && a.image)
      .filter(a => {
        if(seen.has(a.id)) return false;
        seen.add(a.id);
        return true;
      })
      .map(a => ({
        title: a.name,
        poster: a.image
      }));

    if(clean.length < 16) throw new Error();

    pool = shuffle(clean);
    items = pool.splice(0,16);
    initialRound=[...items];
    rounds=[]; winners=[]; idx=0;

    next();
  }catch{
    document.getElementById("duel").innerHTML =
      `<div><b>Erro ao carregar artistas</b><br>
       <button onclick="location.reload()">Voltar</button></div>`;
  }
}

function next(){
  if(idx>=items.length){
    rounds.push([...winners]);
    items=winners; winners=[]; idx=0;
    if(items.length===1) return showFinal(items[0]);
  }
  atual=[items[idx],items[idx+1]];
  idx+=2;
  document.getElementById("duel").innerHTML=
    card(atual[0],0)+card(atual[1],1);
}

function card(f,i){
  return `<div class="card">
    <img src="${f.poster}" onclick="choose(${i})">
    <div class="title">${f.title}</div>
  </div>`;
}

function choose(i){
  winners.push(atual[i]);
  next();
}

function showFinal(champ){
  const r1=initialRound,r2=rounds[0],r3=rounds[1],r4=rounds[2];
  const left8=r1.slice(0,8), right8=r1.slice(8);
  const left4=r2.slice(0,4), right4=r2.slice(4);
  const left2=r3.slice(0,2), right2=r3.slice(2);

  document.getElementById("duel").innerHTML=`
  <div class="bracket">
    <div class="side">
      <div class="round r1">${left8.map(f=>`<img src="${f.poster}">`).join("")}</div>
      <div class="round r2">${left4.map(f=>`<img src="${f.poster}">`).join("")}</div>
      <div class="round r3">${left2.map(f=>`<img src="${f.poster}">`).join("")}</div>
      <div class="round r4"><img src="${r4[0].poster}"></div>
    </div>

    <div class="champion">
      <img src="${champ.poster}">
      <div class="title">Campeão<br>${champ.title}</div>
      <button id="again" onclick="location.reload()">Jogar novamente</button>
    </div>

    <div class="side">
      <div class="round r4"><img src="${r4[1].poster}"></div>
      <div class="round r3">${right2.map(f=>`<img src="${f.poster}">`).join("")}</div>
      <div class="round r2">${right4.map(f=>`<img src="${f.poster}">`).join("")}</div>
      <div class="round r1">${right8.map(f=>`<img src="${f.poster}">`).join("")}</div>
    </div>
  </div>`;
}
</script>

</body>
</html>
