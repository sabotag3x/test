<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>MusicDuel</title>

<style>
*{box-sizing:border-box}

body{
  margin:0;
  min-height:100vh;
  background:#000;
  color:#fff;
  font-family:Arial,sans-serif;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:1600px;
  padding:20px;
  text-align:center;
}

#home{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:24px;
}

h1{font-size:44px;margin:0}

button{
  background:#ffbf2f;
  border:none;
  padding:16px 40px;
  border-radius:40px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
}

#game{
  display:none;
  min-height:85vh;
  flex-direction:column;
  justify-content:center;
}

.duel{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:120px;
}

.card{
  width:300px;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.card img{
  width:100%;
  border-radius:18px;
  cursor:pointer;
}

.title{
  margin-top:14px;
  font-size:20px;
  font-weight:bold;
}

/* ===== BRACKET ===== */

.bracket{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:5%;
}

.side{
  display:flex;
  gap:18px;
}

.round{
  display:flex;
  flex-direction:column;
  gap:12px;
}

.round img{border-radius:8px}
.r1 img{width:56px}
.r2 img{width:80px}
.r3 img{width:110px}
.r4 img{width:140px}

.champion{
  display:flex;
  flex-direction:column;
  align-items:center;
}

.champion img{
  width:320px;
  border-radius:16px;
}

.champion .title{
  font-size:24px;
  margin-top:12px;
}
</style>
</head>

<body>

<div class="container">

<div id="home">
  <h1>MusicDuel</h1>
  <button onclick="startList('test')">Bandas – Teste</button>
</div>

<div id="game">
  <div id="duel"></div>
</div>

</div>

<script>
let pool=[], items=[], atual=[], idx=0, winners=[], rounds=[];
let initialRound=[];

function shuffle(a){ return a.sort(()=>Math.random()-.5); }

async function startList(key){
  document.getElementById("home").style.display="none";
  document.getElementById("game").style.display="flex";

  try{
    const res = await fetch(`/api/music/list/${key}`);
    const data = await res.json();

    const artists = data.artists.map(a => ({
      title: a.name,
      poster: a.image
    }));

    if(artists.length < 16) throw new Error();

    pool = shuffle(artists);
    items = pool.splice(0,16);
    initialRound=[...items];
    rounds=[]; winners=[]; idx=0;

    next();
  }catch{
    document.getElementById("duel").innerHTML =
      `<div><b>Erro ao carregar artistas</b>
       <br><button onclick="location.reload()">Voltar</button></div>`;
  }
}

function next(){
  if(idx>=items.length){
    rounds.push([...winners]);
    items=winners; winners=[]; idx=0;
    if(items.length===1) return showFinal(items[0]);
  }
  atual=[items[idx],items[idx+1]];
  idx+=2;
  document.getElementById("duel").innerHTML=
    `<div class="duel">
      ${card(atual[0],0)}
      ${card(atual[1],1)}
     </div>`;
}

function card(f,i){
  return `<div class="card">
    <img src="${f.poster}" onclick="choose(${i})">
    <div class="title">${f.title}</div>
  </div>`;
}

function choose(i){
  winners.push(atual[i]);
  next();
}

function showFinal(champ){
  const r1=initialRound,r2=rounds[0],r3=rounds[1],r4=rounds[2];
  const left8=r1.slice(0,8), right8=r1.slice(8);
  const left4=r2.slice(0,4), right4=r2.slice(4);
  const left2=r3.slice(0,2), right2=r3.slice(2);

  document.getElementById("duel").innerHTML=`
  <div class="bracket">
    <div class="side">
      <div class="round r1">${left8.map(f=>`<img src="${f.poster}">`).join("")}</div>
      <div class="round r2">${left4.map(f=>`<img src="${f.poster}">`).join("")}</div>
      <div class="round r3">${left2.map(f=>`<img src="${f.poster}">`).join("")}</div>
      <div class="round r4"><img src="${r4[0].poster}"></div>
    </div>

    <div class="champion">
      <img src="${champ.poster}">
      <div class="title">Campeão<br>${champ.title}</div>
      <button onclick="location.reload()">Jogar novamente</button>
    </div>

    <div class="side">
      <div class="round r4"><img src="${r4[1].poster}"></div>
      <div class="round r3">${right2.map(f=>`<img src="${f.poster}">`).join("")}</div>
      <div class="round r2">${right4.map(f=>`<img src="${f.poster}">`).join("")}</div>
      <div class="round r1">${right8.map(f=>`<img src="${f.poster}">`).join("")}</div>
    </div>
  </div>`;
}
</script>

</body>
</html>
