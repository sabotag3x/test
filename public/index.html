<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FilmDuel – Batalha de Filmes</title>

  <style>
*{box-sizing:border-box}

body{
  margin:0;
  min-height:100vh;
  background:#000;
  color:#fff;
  font-family:Arial,sans-serif;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:1600px;
  padding:14px 24px 32px;
  text-align:center;
}

/* ================= HOME ================= */

#home{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:22px;
}

h1{font-size:44px;margin:0}

.subtitle{
  opacity:.85;
  margin-bottom:10px;
  font-size:18px;
}

input{
  padding:16px 22px;
  border-radius:30px;
  border:none;
  width:300px;
  font-size:17px;
  text-align:center;
}

button{
  background:#ffbf2f;
  border:none;
  padding:16px 38px;
  border-radius:40px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
}

.lists{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:18px 22px;
  margin-top:34px;
  max-width:900px;
}

/* ================= GAME ================= */

#game{
  display:none;
  min-height:85vh;
  flex-direction:column;
  justify-content:center;
}

#status{
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:flex-end;
  padding-top:120px;
}

#countdown{
  width:260px;
  max-width:80vw;
  margin-bottom:26px;
}

#loading-main{
  font-size:34px;
  font-weight:bold;
  color:#ffbf2f;
}

#loading-sub{
  margin-top:10px;
  font-size:17px;
  opacity:.9;
}

/* ================= DUELO ================= */

.duel{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:120px;
  min-height:520px;
}

.card{
  width:300px;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.card img{
  width:100%;
  border-radius:18px;
  cursor:pointer;
  transition:transform .2s;
}
.card img:hover{transform:scale(1.05)}

.title{
  margin-top:18px;
  width:100%;
  font-size:18px;
  line-height:1.3;
  text-align:center;
}

/* ================= RESULTADO ================= */

.bracket{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:90px;
}

.side{
  display:flex;
  gap:26px;
  align-items:center;
}

.round{
  display:flex;
  flex-direction:column;
  gap:14px;
}

.round img{
  border-radius:8px;
}

.r1 img{width:55px}
.r2 img{width:80px}
.r3 img{width:120px}

.champion{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:14px;
}

.champion img{
  width:360px;
  border-radius:22px;
}

.champion .title{
  font-size:24px;
  font-weight:bold;
}

#again{
  margin-top:12px;
  padding:14px 36px;
}

/* ================= MOBILE ================= */


/* ================= MOBILE GERAL ================= */

@media (max-width: 768px){

  body{
    font-size: 18px;
  }

  .container{
    padding: 12px 16px 24px;
  }

  h1{
    font-size: 34px;
  }

  .subtitle{
    font-size: 16px;
  }

  input{
    width: 90%;
    font-size: 18px;
    padding: 16px 20px;
  }

  button{
    font-size: 18px;
    padding: 16px 28px;
  }

  .lists{
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    width: 100%;
  }

  .lists button{
    width: 100%;
    padding: 16px 18px;
    font-size: 16px;
  }
}

/* ================= LOADING ================= */

#status{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  min-height:50vh;
}

#loading-main{
  font-size: clamp(26px, 6vw, 34px);
}

#loading-sub{
  font-size: clamp(16px, 4vw, 18px);
  margin-top:10px;
}

/* ================= DUELO ================= */

.duel{
  align-items:center;
}

@media (max-width: 768px){

  .duel{
    gap: 6vw;
    min-height: auto;
  }

  .card{
    width: 42vw;
  }

  .card img{
    width: 100%;
  }

  .title{
    font-size: 15px;
    margin-top: 10px;
    -webkit-line-clamp: unset;
  }
}

/* ================= RESULTADO FINAL ================= */

/* ---- DESKTOP (ajuste fino, NÃO quebra) ---- */

/* ================= RESULTADO FINAL ================= */

/* ---- DESKTOP (mantém como está, não quebra) ---- */

.bracket{
  max-width:1200px;
  margin:0 auto;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:4%;
}

.side{
  width:20%;
  display:flex;
  justify-content:center;
}

.champion{
  width:40%;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.champion img{
  width:100%;
  height:auto;
  border-radius:22px;
}

/* ---- MOBILE DEFINITIVO (REGRA 50 / 40 / 10) ---- */

@media (max-width: 900px){

  .bracket{
    flex-direction:column;
    gap:4vh;
    width:100%;
  }

  /* COLUNAS DE CIMA (SEMIFINALISTAS) */
  .side{
    width:40vw;              /* 40% total reservado */
    max-width:40vw;
    display:flex;
    justify-content:space-between;
    gap:2vw;
  }

  .round{
    display:flex;
    flex-direction:column;
    gap:1.5vh;
  }

  /* cada coluna interna divide o espaço */
  .round img{
    width:100%;
    height:auto;
  }

  /* CAMPEÃO */
  .champion{
    width:50vw;              /* 50% cravado */
    max-width:50vw;
    align-items:center;
  }

  .champion img{
    width:100%;
    height:auto;
  }

  .champion .title{
    font-size:20px;
    text-align:center;
    margin-top:12px;
  }

  #again{
    margin-top:14px;
    font-size:18px;
    padding:14px 30px;
  }
}

/* ---- MOBILE MUITO PEQUENO ---- */

@media (max-width: 420px){

  .side{
    width:38vw;
    max-width:38vw;
  }

  .champion{
    width:48vw;
    max-width:48vw;
  }
}



    </style>
</head>

<body>
<div class="container">

<!-- ================= HOME ================= -->

<div id="home">
  <h1>FilmDuel</h1>
  <div class="subtitle">Batalha dos seus filmes avaliados no Letterboxd</div>

  <input id="user" placeholder="Seu usuário no Letterboxd">
  <button onclick="startUser()">Meus filmes</button>

  <div class="subtitle" style="margin-top:18px">
  Listas prontas
</div>

  <div class="lists">
    <button onclick="startList('https://letterboxd.com/dave/list/official-top-250-narrative-feature-films/')">Top 250 Letterboxd</button>
    <button onclick="startList('https://letterboxd.com/dave/list/imdb-top-250/')">IMDb Top 250</button>
    <button onclick="startList('https://letterboxd.com/jack/list/official-top-250-films-with-the-most-fans/')">Mais Populares</button>
    <button onclick="startList('https://letterboxd.com/lifeasfiction/list/letterboxd-100-animation/')">Animação</button>
    <button onclick="startList('https://letterboxd.com/petitebutfierce/list/disney/')">Disney</button>
    <button onclick="startList('https://letterboxd.com/jaywill/list/ghibli/')">Ghibli</button>
    <button onclick="startList('https://letterboxd.com/purecinema1/list/brazil/')">Brasil</button>
    <button onclick="startList('https://letterboxd.com/jack/list/official-top-250-documentary-films/')">Documentários</button>
    <button onclick="startList('https://letterboxd.com/chris_coke/list/letterboxds-top-250-science-fiction-films/')">Ficção Científica</button>
    <button onclick="startList('https://letterboxd.com/brsan/list/letterboxds-top-250-international-films/')">Estrangeiros</button>
    <button onclick="startList('https://letterboxd.com/oscars/list/oscar-winning-films-best-picture/')">Oscar</button>
    <button onclick="startList('https://letterboxd.com/festival_cannes/list/70-years-of-the-palme-dor-70-ans-de-la-palme/')">Palma de Ouro</button>
    <button onclick="startList('https://letterboxd.com/bafta/list/all-bafta-best-film-award-winners/')">BAFTA</button>
    <button onclick="startList('https://letterboxd.com/jbutts15/list/the-complete-criterion-collection/')">Criterion</button>
    <button onclick="startList('https://letterboxd.com/a24/list/every-a24-movie-ever/')">A24</button>
    <button onclick="startList('https://letterboxd.com/crew/list/the-2010s-top-250-narrative-features/')">Década 2010</button>
    <button onclick="startList('https://letterboxd.com/victorp26/list/mcu/')">Universo Marvel</button>
    <button onclick="startList('https://letterboxd.com/darrencb/list/letterboxds-top-250-horror-films/')">Terror</button>
  </div>
</div>

<!-- ================= GAME ================= -->

<div id="game">
  <div id="status">
    <img id="countdown" src="https://upload.wikimedia.org/wikipedia/commons/a/a0/Buster_Keaton_as_a_bellboy_in_the_March_18_1918_movie_The_Bell_Boy.gif">
    <div id="loading-main">Carregando lista…</div>
    <div id="loading-sub">Preparando o projetor</div>
  </div>

  <div id="duel" class="duel"></div>
</div>

</div>

<script>
let pool=[], filmes=[], atual=[], idx=0, winners=[], rounds=[];
let initialRound=[];
let loadingTimer=null;

const loadingTexts=[
"Conferindo se o director’s cut é melhor mesmo",
"Brigando com cinéfilo nos comentários",
"Reclamando que o livro era melhor",
"Procurando a cena pós-créditos",
"Ajustando legenda fora de sincronia",
"Decidindo se é cult ou só chato",
"Fingindo que entendeu o final",
"Ignorando spoilers no Twitter",
"Discutindo plano-sequência imaginário",
"Tentando lembrar onde já viu esse ator",
"Checando se ganhou Palma de Ouro",
"Fingindo que viu em 35mm",
"Explicando por que preto e branco é arte",
"Procurando o filme antes de virar modinha",
"Atualizando ranking pessoal no Letterboxd"
];

function shuffle(a){return a.sort(()=>Math.random()-.5)}

function startLoading(){
  document.getElementById("status").style.display="flex";
  let i=0;
  document.getElementById("loading-sub").innerText=loadingTexts[0];
  loadingTimer=setInterval(()=>{
    i=(i+1)%loadingTexts.length;
    document.getElementById("loading-sub").innerText=loadingTexts[i];
  },2300);
}

function stopLoading(){
  clearInterval(loadingTimer);
  document.getElementById("status").style.display="none";
}

async function startUser(){
  const u=document.getElementById("user").value.trim();
  start(`/api/user/${u}`);
}

async function startList(url){
  start(`/api/list?url=${encodeURIComponent(url)}`);
}

async function start(endpoint){
  document.getElementById("home").style.display = "none";
  document.getElementById("game").style.display = "flex";
  startLoading();

  try{
    const res = await fetch(endpoint);
    const data = await res.json();

    const valid = Array.isArray(data)
      ? data.filter(f => f && f.poster)
      : [];

    if(valid.length < 16){
      throw new Error("NOT_ENOUGH");
    }

    pool = shuffle(valid);
    filmes = pool.splice(0,16);
    initialRound = [...filmes];
    rounds = [];
    winners = [];
    idx = 0;

    stopLoading();
    next();

  }catch(e){
    stopLoading();
    showError(
      e.message === "NOT_ENOUGH"
        ? "Esse usuário não tem filmes suficientes para a batalha."
        : "Usuário inexistente ou erro ao carregar os filmes."
    );
  }
}
  function showError(msg){
  document.getElementById("duel").innerHTML = `
    <div style="text-align:center;max-width:420px">
      <div style="font-size:20px;margin-bottom:14px">${msg}</div>
      <button onclick="location.reload()">Voltar</button>
    </div>
  `;
}


function next(){
  if(idx>=filmes.length){
    rounds.push([...winners]);
    filmes=winners; winners=[]; idx=0;
    if(filmes.length===1) return showFinal(filmes[0]);
  }

  atual=[filmes[idx],filmes[idx+1]];
  idx+=2;

  document.getElementById("duel").innerHTML=
    card(atual[0],0)+card(atual[1],1);
}

function card(f,i){
  return `
  <div class="card">
    <img src="${f.poster}" onclick="choose(${i})">
    <div class="title">${f.title} (${f.year})</div>
  </div>`;
}

function choose(i){
  winners.push(atual[i]);
  next();
}

function showFinal(champ){
  const left8  = initialRound.slice(0,8);
  const right8 = initialRound.slice(8,16);

  document.getElementById("duel").innerHTML = `
    <div class="bracket">

      <!-- QUARTAS ESQUERDA -->
      <div class="side">
        <div class="round r1">
          ${left8.map(f=>`<img src="${f.poster}">`).join("")}
        </div>

        <div class="round r2">
          ${rounds[0].slice(0,4).map(f=>`<img src="${f.poster}">`).join("")}
        </div>

        <div class="round r3">
          ${rounds[1].slice(0,2).map(f=>`<img src="${f.poster}">`).join("")}
        </div>
      </div>

      <!-- CAMPEÃO -->
      <div class="champion">
        <img src="${champ.poster}">
        <div class="title">
          Campeão<br>${champ.title} (${champ.year})
        </div>
        <button id="again" onclick="location.reload()">Jogar novamente</button>
      </div>

      <!-- DIREITA -->
      <div class="side">
        <div class="round r3">
          ${rounds[1].slice(2,4).map(f=>`<img src="${f.poster}">`).join("")}
        </div>

        <div class="round r2">
          ${rounds[0].slice(4,8).map(f=>`<img src="${f.poster}">`).join("")}
        </div>

        <div class="round r1">
          ${right8.map(f=>`<img src="${f.poster}">`).join("")}
        </div>
      </div>

    </div>
  `;
}
  
</script>

</body>
</html>

