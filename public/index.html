<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FilmDuel – Batalha de Filmes</title>

<style>
*{box-sizing:border-box}

/* ================= BASE ================= */

body{
  margin:0;
  min-height:100vh;
  background:#000;
  color:#fff;
  font-family:Arial,sans-serif;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:1600px;
  padding:14px 24px 32px;
  text-align:center;
}

button{
  background:#ffbf2f;
  border:none;
  padding:16px 38px;
  border-radius:40px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
}

/* ================= HOME ================= */

#home{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:22px;
}

h1{font-size:44px;margin:0}

.subtitle{
  opacity:.85;
  font-size:18px;
}

input{
  padding:16px 22px;
  border-radius:30px;
  border:none;
  width:300px;
  font-size:17px;
  text-align:center;
}

.lists{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:18px 22px;
  margin-top:34px;
  max-width:900px;
}

/* ================= GAME / LOADING ================= */

#game{
  display:none;
  min-height:85vh;
  flex-direction:column;
  justify-content:center;
}

#status{
  display:none;
  flex-direction:column;
  align-items:center;
  padding-top:120px;
}

#loading-main{
  font-size:34px;
  font-weight:bold;
  color:#ffbf2f;
}

#loading-sub{
  margin-top:10px;
  font-size:17px;
  opacity:.9;
}

/* ================= DUELO CLÁSSICO ================= */

.duel{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:120px;
  min-height:520px;
}

.card{
  width:300px;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.card img{
  width:100%;
  border-radius:18px;
  cursor:pointer;
  transition:.2s;
}
.card img:hover{transform:scale(1.05)}

.title{
  margin-top:18px;
  font-size:18px;
  line-height:1.3;
}

/* ================= BRACKET ================= */

.bracket{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:5%;
  max-width:1400px;
  margin:auto;
}

.side{display:flex;gap:18px;align-items:center}
.round{display:flex;flex-direction:column;gap:12px}
.round img{border-radius:8px}

.r1 img{width:56px}
.r2 img{width:80px}
.r3 img{width:110px}
.r4 img{width:140px}

/* ================= CAMPEÃO (MODO CLÁSSICO) ================= */

.champion{
  max-width:420px;
  margin:40px auto;
  text-align:center;
}

.champion img{
  width:100%;
  max-width:360px;
  border-radius:14px;
  margin-bottom:16px;
}

.champion .title{
  font-size:22px;
  font-weight:bold;
}

/* ================= VERSUS – DUELO ================= */

.versus-container{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:20px;
  max-width:900px;
  margin:auto;
}

.versus-card{
  flex:1;
  text-align:center;
}

.versus-card img{
  width:100%;
  max-width:260px;
  border-radius:12px;
  cursor:pointer;
}

.versus-center{
  width:100px;
  text-align:center;
  font-weight:bold;
}

.versus-center .score{font-size:22px}
.versus-center .progress{font-size:14px;opacity:.7}

/* ================= VERSUS – RESULTADO ================= */

.versus-result{
  max-width:900px;
  margin:auto;
  text-align:center;
}

.winner-posters,
.loser-posters{
  display:flex;
  justify-content:center;
  flex-wrap:wrap;
  gap:12px;
}

.winner-posters img{
  width:80px;
  border-radius:10px;
}

.loser-posters img{
  width:56px;
  border-radius:8px;
  opacity:.85;
}

.winner-title{
  margin:20px 0 10px;
  font-size:28px;
}

.final-score{
  font-size:16px;
  opacity:.8;
  margin-bottom:20px;
}

.loser-title{
  margin:10px 0;
  opacity:.9;
}

/* ================= MOBILE ================= */

@media(max-width:900px){
  .bracket{flex-direction:column;gap:16px}
  .side{flex-direction:column;gap:10px}
  .round{flex-direction:row;flex-wrap:wrap;justify-content:center;gap:8px}
  .round img{width:9vw;max-width:42px;min-width:30px}
  .champion img{max-width:220px}
}

@media(max-width:700px){
  .versus-container{flex-direction:column}
  .versus-center{order:-1;margin-bottom:10px}
  .winner-posters img{width:64px}
  .loser-posters img{width:46px}
}
</style>

</head>

<body>
<div class="container">

<div id="home">
  <h1>FilmDuel</h1>
  <div class="subtitle">Batalha dos seus filmes avaliados no Letterboxd</div>

  <input id="user" placeholder="Seu usuário no Letterboxd">
  <button onclick="startUser()">Meus filmes</button>

  <div class="subtitle" style="margin-top:18px">Listas prontas</div>

<div class="lists">
  <button onclick="startList('top_250_letterboxd')">Top 250 Letterboxd</button>
  <button onclick="startList('top_250_imdb')">IMDb Top 250</button>
  <button onclick="startList('a24')">A24</button>
    <button onclick="startList('oscar')">Oscar</button>
  <button onclick="startList('bafta')">BAFTA</button>
  <button onclick="startList('palma_de_ouro')">Palma de Ouro</button>
  <button onclick="startList('2010')">Década 2010</button>
  <button onclick="startList('disney')">Disney</button>
  <button onclick="startList('ghibli')">Ghibli</button>
  <button onclick="startList('universo_marvel')">Universo Marvel</button>
  <button onclick="startList('terror')">Terror</button>
  <button onclick="startList('ficcao')">Ficção Científica</button>
  <button onclick="startList('animacao')">Animação</button>
  <button onclick="startList('documentarios')">Documentários</button>
  <button onclick="startList('estrangeiros')">Estrangeiros</button>
  <button onclick="startList('brasileiros')">Brasileiros</button>
  <button onclick="startList('populares')">Populares</button>
  <button onclick="startList('criterion')">Criterion</button>
</div>

  <div class="versus">
  <h2>Duelo de Listas</h2>

  <select id="listA">
    <option value="">Lista A</option>
    <option value="disney">Disney</option>
    <option value="ghibli">Ghibli</option>
    <option value="a24">A24</option>
  </select>

  <select id="listB">
    <option value="">Lista B</option>
    <option value="ghibli">Ghibli</option>
    <option value="disney">Disney</option>
    <option value="a24">A24</option>
  </select>

  <button onclick="startVersus()">Iniciar Duelo</button>
</div>


</div>

<div id="game">
  <div id="status">
    <img id="countdown" src="https://upload.wikimedia.org/wikipedia/commons/a/a0/Buster_Keaton_as_a_bellboy_in_the_March_18_1918_movie_The_Bell_Boy.gif">
    <div id="loading-main">Carregando lista…</div>
    <div id="loading-sub">Preparando o projetor</div>
  </div>
  <div id="duel" class="duel"></div>
</div>

</div>

<script>

  const prettyNames = {
  ghibli: "Studio Ghibli",
  a24: "A24",
  disney: "Disney",
  oscar: "Oscar",
  bafta: "BAFTA",
  animacao: "Animação",
  terror: "Terror",
  ficcao: "Ficção Científica",
  brasileiros: "Brasil",
  estrangeiros: "Estrangeiros",
  "2010": "Década de 2010",
  top_250_imdb: "IMDb Top 250",
  top_250_letterboxd: "Letterboxd Top 250",
  universo_marvel: "Universo Marvel",
  criterion: "Criterion Collection",
  palma_de_ouro: "Palma de Ouro",
  populares: "Populares"
};

function pretty(slug){
  return prettyNames[slug] || slug;
}

/* ====== VARIÁVEIS GERAIS ====== */

let pool=[], filmes=[], atual=[], idx=0, winners=[], rounds=[];
let initialRound=[];
let loadingTimer=null;

/* ====== VERSUS ====== */

let versusA=[], versusB=[];
let votedA=[], votedB=[];
let scoreA=0, scoreB=0;
let versusIndex=0;
let versusNames={};

/* ====== TEXTOS ====== */

const loadingTexts=[
  "Conferindo se o director’s cut é melhor mesmo",
  "Reclamando que o livro era melhor",
  "Fingindo que entendeu o final",
  "Discutindo plano-sequência imaginário",
  "Atualizando ranking pessoal no Letterboxd"
];

function shuffle(a){ return a.sort(()=>Math.random()-.5); }

/* ====== LOADING ====== */

function startLoading(){
  document.getElementById("status").style.display="flex";
  let i=0;
  document.getElementById("loading-sub").innerText=loadingTexts[0];
  loadingTimer=setInterval(()=>{
    i=(i+1)%loadingTexts.length;
    document.getElementById("loading-sub").innerText=loadingTexts[i];
  },2300);
}

function stopLoading(){
  clearInterval(loadingTimer);
  document.getElementById("status").style.display="none";
}

/* ====== ENTRY ====== */

function startUser(){
  const u=document.getElementById("user").value.trim();
  if(!u) return;
  start(`/api/user/${u}`, true);
}

function startList(key){
  start(`/api/list/${key}`, false);
}

/* ====== TORNEIO NORMAL ====== */

async function start(endpoint, isUser){
  document.getElementById("home").style.display="none";
  document.getElementById("game").style.display="flex";
  startLoading();

  try{
    const res = await fetch(endpoint);
    if(!res.ok) throw new Error("INVALID");

    const data = await res.json();
    const valid = Array.isArray(data) ? data.filter(f=>f && f.poster) : [];

    if(valid.length < 16) throw new Error("NOT_ENOUGH");

    pool = shuffle(valid);
    filmes = pool.splice(0,16);

    initialRound=[...filmes];
    rounds=[]; winners=[]; idx=0;

    stopLoading();
    next();

  }catch(e){
    stopLoading();
    showError(
      e.message==="NOT_ENOUGH"
        ? "Esse usuário não tem filmes suficientes para a batalha."
        : isUser
          ? "Usuário inexistente ou erro ao carregar os filmes."
          : "Erro ao carregar a lista."
    );
  }
}

function next(){
  if(idx>=filmes.length){
    rounds.push([...winners]);
    filmes=winners; winners=[]; idx=0;
    if(filmes.length===1) return showFinal(filmes[0]);
  }
  atual=[filmes[idx],filmes[idx+1]];
  idx+=2;
  document.getElementById("duel").innerHTML=
    card(atual[0],0)+card(atual[1],1);
}

function card(f,i){
  return `<div class="card">
    <img src="${f.poster}" onclick="choose(${i})">
    <div class="title">${f.title} (${f.year})</div>
  </div>`;
}

function choose(i){ winners.push(atual[i]); next(); }

function showFinal(champ){
  document.getElementById("duel").innerHTML=`
    <div class="champion">
      <img src="${champ.poster}">
      <div class="title">Campeão<br>${champ.title} (${champ.year})</div>
      <button onclick="location.reload()">Jogar novamente</button>
    </div>`;
}

/* ====== VERSUS MODE ====== */

async function startVersus(){
  const a=document.getElementById("listA").value;
  const b=document.getElementById("listB").value;
  if(!a||!b||a===b) return;

  document.getElementById("home").style.display="none";
  document.getElementById("game").style.display="flex";
  startLoading();

  try{
    const [ra, rb] = await Promise.all([
      fetch(`/api/list/${a}`).then(r=>r.json()),
      fetch(`/api/list/${b}`).then(r=>r.json())
    ]);

    versusA=shuffle(ra).slice(0,11);
    versusB=shuffle(rb).slice(0,11);

    if(versusA.length<11||versusB.length<11) throw new Error();

    votedA=[]; votedB=[];
    scoreA=0; scoreB=0; versusIndex=0;
    versusNames={a,b};

    stopLoading();
    nextVersus();

  }catch{
    stopLoading();
    showError("Uma das listas não tem filmes suficientes.");
  }
}

function nextVersus(){
  if(versusIndex>=11) return showVersusResult();

  const fa=versusA[versusIndex];
  const fb=versusB[versusIndex];

  document.getElementById("duel").innerHTML=`
    <div class="versus-container">
      <div class="versus-card">
        <img src="${fa.poster}" onclick="voteA()">
        <div class="title">${fa.title}</div>
      </div>

      <div class="versus-center">
        <div class="score">${scoreA} x ${scoreB}</div>
        <div class="progress">${versusIndex+1}/11</div>
      </div>

      <div class="versus-card">
        <img src="${fb.poster}" onclick="voteB()">
        <div class="title">${fb.title}</div>
      </div>
    </div>`;
}

function voteA(){
  votedA.push(versusA[versusIndex]);
  scoreA++; versusIndex++; nextVersus();
}

function voteB(){
  votedB.push(versusB[versusIndex]);
  scoreB++; versusIndex++; nextVersus();
}

function showVersusResult(){
  const aName = pretty(versusNames.a);
  const bName = pretty(versusNames.b);

  const winnerIsA = scoreA > scoreB;
  const winnerName = winnerIsA ? aName : bName;
  const loserName  = winnerIsA ? bName : aName;

  const winnerPosters = winnerIsA ? votedA : votedB;
  const loserPosters  = winnerIsA ? votedB : votedA;

  document.getElementById("duel").innerHTML=`
    <div class="versus-result">
      
      <div class="winner-posters">
        ${winnerPosters.map(f=>`<img src="${f.poster}">`).join("")}
      </div>

      <h1 class="winner-title">${winnerName} venceu!</h1>

      <div class="final-score">
        Placar final: ${scoreA} x ${scoreB}
      </div>

      <h3 class="loser-title">${loserName}</h3>

      <div class="loser-posters">
        ${loserPosters.map(f=>`<img src="${f.poster}">`).join("")}
      </div>

      <button class="again" onclick="location.reload()">Novo duelo</button>
    </div>
  `;
}


/* ====== ERROR ====== */

function showError(msg){
  document.getElementById("duel").innerHTML=
    `<div><b>${msg}</b><br>
     <button onclick="location.reload()">Voltar</button></div>`;
}
</script>



</body>
</html>
