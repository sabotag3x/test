<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FilmDuel – Batalha de Filmes</title>

<style>
*{box-sizing:border-box}

body{
  margin:0;
  min-height:100vh;
  background:#000;
  color:#fff;
  font-family:Arial,sans-serif;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:1600px;
  padding:40px;
  text-align:center;
}

/* ================= HOME ================= */

#home{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:22px;
}

h1{font-size:44px;margin:0}

.subtitle{
  opacity:.85;
  margin-bottom:10px;
}

input{
  padding:14px 20px;
  border-radius:30px;
  border:none;
  width:280px;
  font-size:16px;
  text-align:center;
}

button{
  background:#ffbf2f;
  border:none;
  padding:14px 34px;
  border-radius:40px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
}

.lists{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:14px;
  margin-top:10px;
}

/* ================= GAME ================= */

#game{display:none}

#status{
  margin:40px 0 20px;
}

#loading-main{
  font-size:28px;
  font-weight:bold;
  color:#ffbf2f;
}

#loading-sub{
  margin-top:10px;
  font-size:16px;
  opacity:.9;
}

/* ================= DUELO ================= */

.duel{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:120px;
  min-height:520px;
}

.card{
  width:260px;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.card img{
  width:100%;
  border-radius:16px;
  cursor:pointer;
  transition:transform .2s;
}
.card img:hover{transform:scale(1.05)}

.title{
  margin-top:10px;
  width:100%;
  max-width:260px;
  font-size:16px;
  line-height:1.2;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

/* ================= RESULTADO ================= */

.bracket{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:90px;
}

.side{
  display:flex;
  gap:26px;
}

.round{
  display:flex;
  flex-direction:column;
  gap:14px;
}

.round img{
  border-radius:8px;
}

.r1 img{width:70px}
.r2 img{width:90px}
.r3 img{width:120px}

.champion{
  display:flex;
  flex-direction:column;
  align-items:center;
}

.champion img{
  width:360px;
  border-radius:24px;
}

.champion .title{
  margin-top:14px;
  font-size:22px;
  font-weight:bold;
}

#again{
  display:none;
  margin-top:40px;
}
</style>
</head>

<body>
<div class="container">

<!-- ================= HOME ================= -->

<div id="home">
  <h1>FilmDuel</h1>
  <div class="subtitle">Batalha dos seus filmes avaliados no Letterboxd</div>

  <input id="user" value="sabotag3x" placeholder="Usuário Letterboxd">
  <button onclick="startUser()">Meus filmes</button>

  <div class="lists">
    <button onclick="startList('https://letterboxd.com/dave/list/official-top-250-narrative-feature-films/')">Top 250</button>
    <button onclick="startList('https://letterboxd.com/jack/list/official-top-250-films-with-the-most-fans/')">Populares</button>
    <button onclick="startList('https://letterboxd.com/lifeasfiction/list/letterboxd-100-animation/')">Animação</button>
    <button onclick="startList('https://letterboxd.com/jaywill/list/ghibli/')">Ghibli</button>
    <button onclick="startList('https://letterboxd.com/a24/list/every-a24-movie-ever/')">A24</button>
    <button onclick="startList('https://letterboxd.com/purecinema1/list/brazil/')">Brasil</button>
  </div>
</div>

<!-- ================= GAME ================= -->

<div id="game">
  <div id="status">
    <div id="loading-main">Carregando lista…</div>
    <div id="loading-sub"></div>
  </div>

  <div id="duel" class="duel"></div>
  <button id="again" onclick="location.reload()">Jogar novamente</button>
</div>

</div>

<script>
let pool=[], filmes=[], atual=[], idx=0, winners=[], rounds=[];
let loadingTimer=null;

const loadingTexts=[
  "Polindo estatueta do Oscar",
  "Escolhendo os melhores filmes",
  "Discutindo com críticos no Letterboxd",
  "Recontando votos do júri",
  "Rebobinando VHS",
  "Ajustando projeção 35mm"
];

function shuffle(a){return a.sort(()=>Math.random()-.5)}

function startLoading(){
  let i=0;
  document.getElementById("loading-sub").innerText=loadingTexts[0];
  loadingTimer=setInterval(()=>{
    i=(i+1)%loadingTexts.length;
    document.getElementById("loading-sub").innerText=loadingTexts[i];
  },2500);
}

function stopLoading(){
  clearInterval(loadingTimer);
  document.getElementById("status").innerHTML="";
}

async function startUser(){
  const u=document.getElementById("user").value.trim();
  start(`/api/user/${u}`);
}

async function startList(url){
  start(`/api/list?url=${encodeURIComponent(url)}`);
}

async function start(endpoint){
  document.getElementById("home").style.display="none";
  document.getElementById("game").style.display="block";
  startLoading();

  const res=await fetch(endpoint);
  pool=shuffle(await res.json()).filter(f=>f.poster);

  filmes=pool.splice(0,16);
  rounds=[]; winners=[]; idx=0;

  stopLoading();
  next();
}

function next(){
  if(idx>=filmes.length){
    rounds.push([...winners]);
    filmes=winners; winners=[]; idx=0;

    if(filmes.length===1) return showFinal(filmes[0]);
  }

  atual=[filmes[idx],filmes[idx+1]];
  idx+=2;

  document.getElementById("duel").innerHTML=
    card(atual[0],0)+card(atual[1],1);
}

function card(f,i){
  return `
  <div class="card">
    <img src="${f.poster}" onclick="choose(${i})">
    <div class="title">${f.title} (${f.year})</div>
  </div>`;
}

function choose(i){
  winners.push(atual[i]);
  next();
}

function showFinal(champ){
  document.getElementById("duel").innerHTML=`
    <div class="bracket">
      <div class="side">
        ${rounds.map((r,i)=>`
          <div class="round r${i+1}">
            ${r.map(f=>`<img src="${f.poster}">`).join("")}
          </div>`).join("")}
      </div>

      <div class="champion">
        <img src="${champ.poster}">
        <div class="title">Campeão<br>${champ.title} (${champ.year})</div>
      </div>

      <div class="side">
        ${rounds.slice().reverse().map((r,i)=>`
          <div class="round r${rounds.length-i}">
            ${r.slice().reverse().map(f=>`<img src="${f.poster}">`).join("")}
          </div>`).join("")}
      </div>
    </div>
  `;
  document.getElementById("again").style.display="inline-block";
}
</script>

</body>
</html>
