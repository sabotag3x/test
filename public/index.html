<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FilmDuel</title>

<style>
body{margin:0;background:#000;color:#fff;font-family:Arial}
.hidden{display:none}
button{cursor:pointer}

#home{
  text-align:center;
  padding:40px
}

input{
  padding:14px;
  width:260px;
  border-radius:30px;
  border:none;
  text-align:center
}

.btn{
  background:linear-gradient(135deg,#ffcc00,#ff9900);
  color:#000;
  padding:12px 28px;
  border-radius:30px;
  font-weight:bold;
  border:none;
  margin:8px
}

#game{
  padding:40px;
  text-align:center
}

.duel{
  display:flex;
  justify-content:center;
  gap:80px
}

.card img{
  width:260px;
  border-radius:14px
}

.back{
  margin-top:30px
}
</style>
</head>

<body>

<div id="home">
  <h1>FilmDuel</h1>
  <p>Batalha de filmes do Letterboxd</p>

  <input id="user" value="sabotag3x">
  <br>
  <button class="btn" onclick="startUser()">Meus filmes</button>

  <h3>Listas</h3>
  <button class="btn" onclick="startList('imdb250')">IMDb Top 250</button>
  <button class="btn" onclick="startList('animation')">Animação</button>
  <button class="btn" onclick="startList('a24')">A24</button>
  <button class="btn" onclick="startList('ghibli')">Ghibli</button>
</div>

<div id="game" class="hidden">
  <div id="duel"></div>
  <button class="btn back" onclick="goHome()">Jogar novamente</button>
</div>

<script>
let filmes=[], index=0, atual=[], vencedores=[];

function shuffle(a){
  return [...a].sort(()=>Math.random()-0.5);
}

function goHome(){
  document.getElementById("game").classList.add("hidden");
  document.getElementById("home").classList.remove("hidden");
}

async function startUser(){
  const u=document.getElementById("user").value;
  const r=await fetch(`/api/user/${u}`);
  init(await r.json());
}

async function startList(id){
  const r=await fetch(`/api/list/${id}`);
  init(await r.json());
}

async function init(pool){
  document.getElementById("home").classList.add("hidden");
  document.getElementById("game").classList.remove("hidden");

  const sel=shuffle(pool).slice(0,16);
  const lang=navigator.language||"pt-BR";

  const r=await fetch("/api/tmdb",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ films:sel, lang })
  });

  filmes=await r.json();
  index=0;
  vencedores=[];
  next();
}

function next(){
  if(index>=filmes.length){
    filmes=vencedores;
    vencedores=[];
    index=0;
    if(filmes.length===1){
      document.getElementById("duel").innerHTML=
        `<h2>Campeão<br>${filmes[0].title}</h2>`;
      return;
    }
    next();
    return;
  }

  atual=[filmes[index],filmes[index+1]];
  index+=2;

  document.getElementById("duel").innerHTML=
    `<div class="duel">
      <div class="card"><img src="${atual[0].poster}" onclick="pick(0)"><p>${atual[0].title}</p></div>
      <div class="card"><img src="${atual[1].poster}" onclick="pick(1)"><p>${atual[1].title}</p></div>
    </div>`;
}

function pick(i){
  vencedores.push(atual[i]);
  next();
}
</script>
</body>
</html>
